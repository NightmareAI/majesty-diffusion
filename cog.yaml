build:
  gpu: true
  system_packages:
    - "git-lfs"
    - "ffmpeg"
    - "libsm6"
    - "libxext6"
    - "libglib2.0-0"

  python_version: "3.8"

  python_packages:
    - "dotmap==1.3.30"
    - "einops==0.4.1"
    - "facexlib==0.2.3"
    - "numpy==1.20"
    - "omegaconf==2.2.2"
    - "lpips==0.1.4"
    - "opencv-python==4.6.0.66"
    - "piq==0.7.0"
    - "poetry==1.1.13"
    - "pytorch-lightning==1.6.4"
    - "tensorflow==2.8.0"
    - "torch==1.11.0"
    - "torchvision==0.12.0"
    - "torch-fidelity==0.3.0"
    - "transformers==4.19.4"
    - "resize-right==0.0.2"
    - "jupyterlab==3.3.4"

  run:
    - mkdir -p /src
    - echo "Installing libraries..."
    - git clone https://github.com/CompVis/taming-transformers /tmp/taming-transformers
    - pip install -e /tmp/taming-transformers
    - pip install basicsr
    - pip install realesrgan
    - git clone https://github.com/apolinario/Multi-Modal-Comparators /tmp/Multi-Modal-Comparators --branch gradient_checkpointing && cd /tmp/Multi-Modal-Comparators && poetry build && pip install dist/mmc*.whl
    - cd /tmp; python Multi-Modal-Comparators/src/mmc/napm_installs/__init__.py
    - echo "Downloading CLIP models..."
    - cd /tmp; wget -o models.py https://raw.githubusercontent.com/NightmareAI/majesty-diffusion/cog/models.py; python models.py --clip-defaults

image: "r8.im/nightmareai/majesty-diffusion-test"
predict: "predict.py:Predictor"
